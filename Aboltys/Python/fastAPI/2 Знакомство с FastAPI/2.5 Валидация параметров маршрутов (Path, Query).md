
[[#Функция Path]]

##   Функция Path

Функция `**Path**` используется для определения параметров пути в маршрутах FastAPI. Она не только указывает, что параметр является частью пути, но и позволяет задавать правила валидации и метаданные, которые отображаются в документации Swagger UI и ReDoc.

### Параметры Path

- **Метаданные**:
    
    - `title`: Название параметра для документации.
        
    - `description`: Подробное описание параметра.
        
    - `example`: Пример значения параметра.
        
    - `include_in_schema`: Логический параметр, определяющий, включать ли параметр в схему OpenAPI (по умолчанию True).
        
- **Правила валидации**:
    
    - `min_length`: Минимальная длина строки.
        
    - `max_length`: Максимальная длина строки.
        
    - `pattern`: Регулярное выражение для проверки строки.
        
    - `gt`: Значение должно быть больше указанного (для чисел).
        
    - `ge`: Значение должно быть больше или равно указанному.
        
    - `lt`: Значение должно быть меньше указанного.
        
    - `le`: Значение должно быть меньше или равно указанному.
        

  
Обновим код из предыдущей лекции, добавив валидацию параметров пути с использованием функции `Path`:

```python
from fastapi import FastAPI, Path

app = FastAPI()


@app.get("/user/{username}/{age}")
async def login(username: str = Path(min_length=3, max_length=15, description='Enter your username', examples=['Ilya']),
                age: int = Path(ge=0, le=100, description="Enter your age")) -> dict:
    return {"user": username, "age": age}
```

  
Давайте разберемся в данном коде, первым делом мы должны заметить изменения в декораторе, а именно изменился путь, так как функция `Path` работает только с параметрами пути, мы изменили путь на `/user/{username}/{age}`

  
Далее код поля `username: str`, из прошлого раздела, мы изменили на `username: str = Path(min_length=3, max_length=15, description='Enter your username', example='Ilya')`. Добавив проверку на минимальную и максимальную длину имени. Также мы добавили описание поля и добавили в поле пример имени.

  
Код `age: int | None = None` мы изменили на `age: int = Path(ge=0, le=100, description="Enter your age")`. Мы установили границы числа для поля `age` от 0 до 100 и добавили описание поля.

  
Теперь перейдя в документацию по адресу [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs) мы увидим следующее:

![](https://ucarecdn.stepik.net/c158170d-7866-45b3-a272-17bd590e98b4/)

У нас появилось описание поля и пример ввода имени. Давайте попробуем передать данные:

![](https://ucarecdn.stepik.net/25a166e1-602a-4d30-96e3-9b5660d5c926/)

В данном случае мы успешно прошли валидацию, и наша функция отработала и вернула правильный ответ. Теперь давайте попробуем передать ей те параметры, которые не пройдут валидацию:

![](https://ucarecdn.stepik.net/491eb681-b56f-48b9-9df3-9c37a89dfbd5/)

Мы видим что параметр пути `name` длиной менее 3 символов, а параметр `age` это число более 100. В результате проверка не была пройдена.

Также в случае, если мы перейдем по адресу [http://127.0.0.1:8000/user/ilya/33](http://127.0.0.1:8000/user/ilya/33), мы получим результат выполнения функции. Но в случае, если мы перейдем по адресу [http://127.0.0.1:8000/user/ilya/105](http://127.0.0.1:8000/user/ilya/105) мы получим следующую ошибку валидации:

```json
{
    "detail": [
        {
            "type": "less_than_equal",
            "loc": [
                "path",
                "age"
            ],
            "msg": "Input should be less than or equal to 100",
            "input": "105",
            "ctx": {
                "le": 100
            },
            "url": "https://errors.pydantic.dev/2.5/v/less_than_equal"
        }
    ]
}
```
## Порядок параметров

Порядок объявления параметров в функциях-обработчиках FastAPI очень важен. В этой лекции мы рассмотрим, как правильно определять параметры пути и запросов, избегая синтаксических ошибок Python, и как использовать `Annotated` для большей гибкости.

Допустим, вы хотите объявить `age` как обязательный параметр запроса типа `int` к прошлому коду. Но нам по-прежнему нужно использовать `Path` для параметра пути `username`.

```python
from fastapi import FastAPI, Path

app = FastAPI()


@app.get("/user/{username}")
async def login(username: str = Path(min_length=3, max_length=15, description='Enter your username',
                                     examples=['Ilya']), age: int) -> dict:
    return {"user": username, "age": age}
```

  
В Python параметры без значений по умолчанию (обязательные) должны объявляться до параметров с значениями по умолчанию (необязательные).

![](https://ucarecdn.stepik.net/964d977e-111a-4598-9675-21e25f67a897/)

  
Если нарушить это правило, Python выдаст ошибку _SyntaxError: parameter without a default follows parameter with a default_.

  
Чтобы избежать ошибки, можно объявить обязательный параметр `age` перед параметром пути `username`:

```python
from fastapi import FastAPI, Path

app = FastAPI()


@app.get("/user/{username}")
async def login(age: int,
                username: str = Path(min_length=3, max_length=15, description='Enter your username',
                                     examples=['Ilya'])) -> dict:
    return {"user": username, "age": age}
```

  
Обязательный параметр `age` (без значения по умолчанию) объявлен первым, что удовлетворяет требованиям Python.

  
А FastAPI распознаёт параметры по их именам и типам, поэтому порядок в функции не влияет на обработку URL. Например, запрос [http://127.0.0.1:8000/user/Ilya?age=33](http://127.0.0.1:8000/user/Ilya?age=33) вернёт:

```json
{"user": "Ilya", "age": 33}
```

  
Для большей гибкости и читаемости кода FastAPI (с версии 0.95.0) рекомендует использовать `Annotated` из модуля `typing`. Это позволяет задавать параметры пути без зависимости от порядка и избегать синтаксических ошибок.

```python
from typing import Annotated

from fastapi import FastAPI, Path

app = FastAPI()


@app.get("/user/{username}")
async def login(
        username: Annotated[
            str, Path(min_length=3, max_length=15, description='Enter your username',
                      examples=['Ilya'])],
        age: int) -> dict:
    return {"user": username, "age": age}
```

  
`Annotated` позволяет комбинировать тип (`str`) и валидацию (`Path`) без присваивания значения по умолчанию, что устраняет проблему порядка. А также `Annotated` делает код более логичным и поддерживает современные стандарты FastAPI.  
 

### Важное замечание о параметрах пути

Параметры пути (например, `username` в `/user/{username}`) всегда обязательны, так как они составляют часть URL. Попытка задать значение по умолчанию (например, `username: str = "Ilya"`) вызовет ошибку в FastAPI, так как параметр пути не может быть опциональным.

Ссылка на документацию - [https://fastapi.tiangolo.com/ru/tutorial/path-params-numeric-validations/](https://fastapi.tiangolo.com/ru/tutorial/path-params-numeric-validations/)


## Функция Query

Параметры запросов передаются в URL после знака вопроса (`?`), например, `/items?item_id=123`. FastAPI предоставляет функцию `Query` из модуля `fastapi` для определения и валидации параметров запросов. Он позволяет задавать правила валидации и метаданные, которые улучшают документацию API в Swagger UI и ReDoc.


Для работы с параметрами строки запроса фреймворк предоставляет функцию Query из пакета `fastapi`, который используется для определения параметров запроса. Параметры запроса передаются в URL-адресе после знака вопроса (`?`), например:  `/items?item_id=123`.

### Параметры Query

- **Метаданные**:
    
    - `title`: Название параметра для документации.
    - `description`: Подробное описание параметра.
    - `examples`: Примеры значений параметра.
    - `include_in_schema`: Логический параметр, определяющий, включать ли параметр в схему OpenAPI (по умолчанию True).
- **Правила валидации**:
    
    - `min_length`: Минимальная длина строки.
    - `max_length`: Максимальная длина строки.
    - `pattern`: Регулярное выражение для проверки строки.
    - `gt`: Значение должно быть больше указанного (для чисел).
    - `ge`: Значение должно быть больше или равно указанному.
    - `lt`: Значение должно быть меньше указанного.
    - `le`: Значение должно быть меньше или равно указанному.

Теперь, когда мы рассмотрели в прошлом разделе `Annotated`, будем использовать ее, и добавим `Query` со значением параметра `max_length` равным 10:

```python
from typing import Annotated

from fastapi import FastAPI, Path, Query

app = FastAPI()


@app.get("/user/{username}")
async def login(
        username: Annotated[
            str, Path(min_length=3, max_length=15, description='Enter your username',
                      example='permin0ff')],
        first_name: Annotated[str | None, Query(max_length=10)] = None) -> dict:
    return {"user": username, "Name": first_name}
```

Параметр пути `username`: Валидируется с помощью `Path` (минимальная длина 3, максимальная 15).

Параметр запроса `first_name`: Валидируется с помощью `Query` (максимальная длина 10, необязательный, значение по умолчанию `None`).

Обратите внимание, что значение по умолчанию всё ещё `None`, так что параметр запроса будет необязательным. Давайте запустим приложение и попробуем передать запрос, например по адресу [http://127.0.0.1:8000/user/permin0ff?first_name=Ilya](http://127.0.0.1:8000/user/permin0ff?first_name=Ilya) мы увидим следующий вывод:

![](https://ucarecdn.stepik.net/4f9e8e8e-1b60-4640-98de-ad3765ad48b8/)

В случае если мы не будем передавать параметры запроса, например [http://127.0.0.1:8000/user/permin0ff](http://127.0.0.1:8000/user/permin0ff), то получим вывод:

![](https://ucarecdn.stepik.net/edc993a7-f00b-48ad-b5a3-5df30a1ef4ff/)

Отдельно хотелось бы уточнить, что для Python 3.10 и выше мы можем сделать параметр не обязательным, указав:

```python-repl
first_name: Annotated[str | None, Query()] = None)
```

Когда `Query` используется внутри `Annotated`, вы не можете использовать параметр `default` у `Query`. Вместо этого, используйте обычное указание значения по умолчанию для параметра функции. 

```python
first_name: Annotated[str | None, Query()] = "Thomas")
```

В случае, чтобы сделать параметр `Query` обязательным, вы можете просто не указывать значение по умолчанию:

```python
first_name: Annotated[str, Query(max_length=10)]
```

Если по каким-то причинам мы хотим использовать `Query` без `Annotated`, то следует использовать следующий синтаксис:

```python
first_name: str | None = Query(default=None, max_length=10))
```

## Исключение из документации

С помощью параметра `include_in_schema` можно исключить параметр из документации OpenAPI:

```python
first_name: Annotated[str | None, Query(include_in_schema=False)] = None
```

В этом случае `first_name` не будет отображаться в Swagger UI, хотя параметр всё равно будет приниматься в запросах.

![](https://ucarecdn.stepik.net/701cafc9-4882-4ddd-8f98-10901658f34c/)
## Получение списков значений

FastAPI позволяет обрабатывать параметры запросов, содержащие несколько значений для одного ключа, с помощью функции `Query`. Это полезно, когда в строке запроса повторяется один и тот же параметр с разными значениями, формируя список. Например, запрос `[http://127.0.0.1:8000/user?people=Tom&people=Sam&people=Bob](http://127.0.0.1:8000/user?people=Tom&people=Sam&people=Bob)` передаёт три значения для параметра `people`, которые FastAPI интерпретирует как список.


Функция Query из модуля fastapi позволяет указать, что параметр запроса является списком, используя тип `list` с аннотацией типа (например, `list[str]`). FastAPI автоматически собирает все значения параметра в список.

Здесь параметру `people` передаются три разных значения, которые мы получим в виде списка:

```python
from typing import Annotated

from fastapi import FastAPI, Path, Query

app = FastAPI()


@app.get("/user")
async def search(people: Annotated[list[str], Query()]) -> dict:
    return {"user": people}
```

Разберем подробнее параметр `people: Annotated[list[str], Query()]`:

- `list[str]`: Указывает, что параметр ожидает список строк.
- `Query()`: Сообщает FastAPI, что `people` — это параметр запроса.
- Без указания `default` параметр обязателен.

Для запроса [http://127.0.0.1:8000/user?people=Tom&people=Sam&people=Bob](http://127.0.0.1:8000/user?people=Tom&people=Sam&people=Bob) возвращается:

![](https://ucarecdn.stepik.net/6ce878a0-7718-464e-ad9b-c91219e24a9e/)

Документация API будет обновлена соответствующим образом, где будет разрешено множество значений:

![](https://ucarecdn.stepik.net/88399c36-8e5c-4bf3-bfc6-6b4d1b4c2966/)

## Валидация списков

Функция `Query` поддерживает правила валидации для списков, такие как:

- `min_length`: Минимальное количество элементов в списке.
- `max_length`: Максимальное количество элементов в списке.
- `description`: Описание параметра для документации.
- `examples`: Примеры значений для документации.

### Пример: Список с валидацией

```python
from typing import Annotated
from fastapi import FastAPI, Query

app = FastAPI()

@app.get("/user")
async def search(
    people: Annotated[
        list[str],
        Query(min_length=1, max_length=5, description="List of user names", example=["Tom", "Sam"])
    ]
) -> dict:
    return {"user": people}
```

**В этом коде мы используем валидацию**:

- `min_length=1`: Список должен содержать хотя бы один элемент.
- `max_length=5`: Список не может содержать больше 5 элементов.

Для запроса [http://127.0.0.1:8000/user?people=Tom&people=Sam](http://127.0.0.1:8000/user?people=Tom&people=Sam):

```json
{"user": ["Tom", "Sam"]}
```

А если передать пустой список ([http://127.0.0.1:8000/user](http://127.0.0.1:8000/user)) или больше 5 элементов, FastAPI вернёт ошибку 422 с описанием нарушения валидации.


Регулярные выражения (RegEx) — это мощный инструмент для определения шаблонов поиска строк. В Python они реализуются через модуль re из стандартной библиотеки. В FastAPI функции Path и Query поддерживают параметр `pattern`, который позволяет валидировать строковые параметры пути или запросов по заданному регулярному выражению.

## Валидация с помощью RegEx

Регулярные выражения (или `RegEx`) - это последовательность символов, которая определяет шаблон поиска. 

Модуль `re`, включенный в стандартную библиотеку Python, реализует функциональность регулярных выражений. Функции `Path()` и `Query()` в FastAPI позволяют определить параметр `pattern` для проверки, чтобы можно было проверить строковое значение параметра пути/запроса по указанному шаблону поиска.

Давайте добавим параметр `pattern` в функцию `Query()`, чтобы ограничить значение `first_name` либо начинаться с `J`, либо заканчиваться на `s` (как например John, Tomas).

```python
from typing import Annotated

from fastapi import FastAPI, Path, Query

app = FastAPI()


@app.get("/user/{username}")
async def login(
        username: Annotated[
            str, Path(min_length=3, max_length=15, description='Enter your username',
                      examples=['permin0ff'])],
        first_name: Annotated[
            str | None, Query(max_length=10, pattern="^J|s$")] = None) -> dict:
    return {"user": username, "Name": first_name}
```

Запустим приложение и проверим работу валидатора через регулярные выражения. Если мы вводим в поле `first_name` текст `John`, то проверка выполняется успешно.

![](https://ucarecdn.stepik.net/cf76d3a8-ddc5-4bc1-83d1-d2e150b68fbe/)

Но если мы вводим имя, которое не подходит под наше регулярное выражение, то получаем ошибку:

![](https://ucarecdn.stepik.net/cdfb0ee7-9832-481a-8dbb-e60714238bad/)

На этом мы закончим рассмотрение валидации параметров путей и запросов через Path и Query, все возможности вы можете посмотреть в официальной документации - [https://fastapi.tiangolo.com/ru/tutorial/query-params-str-validations/](https://fastapi.tiangolo.com/ru/tutorial/query-params-str-validations/)


## Сравнение параметров пути с параметрами запросов


![[2026-02-16_16-48.png]]



