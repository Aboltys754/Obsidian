# Маршрутизация в FastAPI

[[#Объявление типа параметра]]
[[#Параметры пути]]
[[#очередность путей]]
[[#Параметры запроса]]
[[#Параметры по умолчанию]]


Маршрутизация — это процесс сопоставления HTTP-запросов, отправленных клиентом, с соответствующими обработчиками на сервере. В FastAPI маршруты определяют, как приложение обрабатывает запросы, а обработчики маршрутов (функции) возвращают ответы. FastAPI делает маршрутизацию простой и мощной благодаря поддержке асинхронности и строгой типизации.

## Основы маршрутизации

В FastAPI маршруты создаются с помощью декораторов, таких как `@app.get()`, `@app.post()`, `@app.put()`, `@app.delete()` и других, соответствующих HTTP-методам. Каждый маршрут связан с функцией-обработчиком, которая выполняется при запросе к указанному пути.

FastAPI поддерживает:

- **Простые маршруты**: Для обработки запросов к статическим путям (например, `/`).
- **Динамические маршруты**: Для работы с параметрами пути (например, `/hello/{user}`).
- **Параметры запросов**: Для обработки query-параметров в URL (например, `/items/?limit=10`).

### Объявление типа параметра

FastAPI использует аннотации типов Python для валидации данных и генерации документации. Поддерживаются:

- **Простые типы**: `int`, `str`, `float`, `bool`, `None`.
- **Контейнеры**: `list`, `tuple`, `dict`, `set`.
- **Сложные типы**: `datetime.date`, `datetime.time`, `UUID`, `bytes`, `Decimal`.
- **Типы из модуля** `typing`: `Optional`, `List`, `Dict`, `Set`, `Union`, `Tuple`, `FrozenSet`, `Iterable`, `Deque`.

Типизация помогает FastAPI автоматически проверять данные и генерировать точную документацию в Swagger UI.

### Параметры пути

FastAPI позволяет получать данные запроса из URL-адреса эндпоинта API через параметр пути или переменную пути, что делает URL-адрес несколько динамичным. Этот параметр содержит значение, которое становится частью URL-адреса, обозначенного фигурными скобками (`{}`). После установки этих параметров пути в URL-адресе FastAPI требует, чтобы эти параметры были объявлены с применением подсказок типов.

![](https://ucarecdn.stepik.net/9a3355f0-26b3-4833-a6b1-058f17c5a9b3/)

Давайте добавим новую функцию в наше приложение, функция `welcome_user` будет обрабатывать имя пользователя, получая его из параметра пути:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/")
async def welcome() -> dict:
    return {"message": "Hello World"}


@app.get("/hello/{user}")
async def welcome_user(user: str) -> dict:
    return {"user": f'Hello {user}'}
```

**В этом коде**:

- **Маршрут** `/hello/{user}`: `{user}` — параметр пути, который передаётся в функцию `welcome_user`.
- **Аннотация** `user`: `str`: Указывает, что параметр должен быть строкой. FastAPI автоматически валидирует тип.
- **Ответ**: Возвращается JSON с приветствием, например, `{"message": "Hello Ilya!"}` для запроса `/hello/Ilya`.

И теперь если мы запустим наш сервер командой:

```lua
uvicorn api:app --port 8000 --reload
```

Далее перейдем по адресу, например [http://127.0.0.1:8000/hello/Ilya](http://127.0.0.1:8000/hello/Ilya), то увидим следующий вывод:

![](https://ucarecdn.stepik.net/fb5d8b47-7a1e-42ea-a680-ca44110e977e/)

FastAPI автоматически генерирует интерактивную документацию, доступную по адресу [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs). Для маршрута `/hello/{user}` Swagger UI отображает параметр пути `user` типа `string`.

![](https://ucarecdn.stepik.net/c6c83a48-ce9d-4c82-bb18-3e643b1d19fb/)

Вы можете ввести значение (например, `Ilya`) в интерфейсе и протестировать маршрут, получив ответ от функции.

![](https://ucarecdn.stepik.net/c8af1833-71b2-4b64-92d1-65f39c237a7a/)

После ввода в поле  `user` строки, мы получаем ответ от нашей функции. В следующем шаге мы продолжим работу с маршрутами в FastAPI.

Также по аналогии мы можем передавать несколько параметров в URL-адресе. Изменим наш код, добавив несколько параметров:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/")
async def welcome() -> dict:
    return {"message": "Hello World"}


@app.get("/hello/{first_name}/{last_name}")
async def welcome_user(first_name: str, last_name: str) -> dict:
    return {"user": f'Hello {first_name} {last_name}'}
```

Мы также можем объявить другой тип параметра пути в функции, используя стандартные аннотации типов Python:

```python
@app.get("/order/{order_id}")
async def order(order_id: int) -> dict:
    return {"id": order_id}
```

Обратите внимание на значение `7`, которое получила (и вернула) функция. Это целочисленное значение Python (`int`), а не строка `"7"`.

И теперь если мы попробуем перейти по адресу [http://127.0.0.1:8000/order/test](http://127.0.0.1:8000/order/test), то увидим следующую возвращённую ошибку в виде JSON:

```python
{
    "detail": [
        {
            "type": "int_parsing", # тип ошибки
            "loc": [ # указание на место, где произошла ошибка:
                "path", # в параметре пути
                "order_id" # имя параметра пути
            ],
            "msg": "Input should be a valid integer, unable to parse string as an integer", # текст ошибки
            "input": "test", # полученное значение, которое вызывало ошибку
        }
    ]
}
```

  
FastAPI обеспечивает проверку типов, используя всё те же аннотации типов. Обратите внимание, что в тексте ошибки явно указано место не прошедшее проверку. Это очень полезно при разработке и отладке кода, который взаимодействует с API.

## очередность путей

Также будет немаловажным рассмотреть следующую ситуацию. У нас есть код нашего приложения, включающий функцию `user()`, которая принимает имя пользователя, и функцию `profile()` она ничего не принимает. Но их пути находятся в одном каталоге адресного пути (user).

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/user/{user_name}")
async def user(user_name: str) -> dict:
    return {"user": user_name}


@app.get("/user/profile")
async def profile() -> dict:
    return {"profile": "View profile user"}
```

В результате, если мы перейдем по адресу [http://127.0.0.1:8000/user/ilya](http://127.0.0.1:8000/user/ilya), то увидим следующий вывод функции `user()`:

![](https://ucarecdn.stepik.net/78a27d64-87e4-477e-a907-e4d98cf9529c/)

Но если мы перейдем по адресу [http://127.0.0.1:8000/user/profile](http://127.0.0.1:8000/user/profile), то вывод будет неправильный, а именно вместо функции `profile()`, отработает функция `user()`.![](https://ucarecdn.stepik.net/8f3a32e6-02c5-48f9-8581-ec83afbc9769/)

В этом случае произошло то,  что каталог пути (`profile`) рассматривался как значение параметра имени пользователя для функции `user`. 

Чтобы решить эту проблему, все фиксированные пути должны быть объявлены первыми перед URL-адресами динамических конечных точек с параметрами пути. Таким образом, функция `profile()` должна быть объявлена первой перед функцией `user()`.

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/user/profile")
async def profile() -> dict:
    return {"profile": "View profile user"}


@app.get("/user/{user_name}")
async def user(user_name: str) -> dict:
    return {"user": user_name}
```

### Параметры запроса

Параметры запросов (query parameters) — это пары ключ-значение, которые передаются в URL после вопросительного знака (**`?`**). Они используются для передачи дополнительных данных в API и разделяются амперсандом (**`&`**). Как и параметры пути, параметры запросов объявляются в функции-обработчике с аннотациями типов для автоматической валидации FastAPI.

Напишем новую функцию в наше приложение, использующее параметры запроса:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/user")
async def login(username: str, age: int) -> dict:
    return {"user": username, "age": age}
```

**Разберем этот код**:

- **Маршрут** `/user`: Обрабатывает GET-запросы с параметрами запросов.
- **Параметры**:
- `username: str`: Строковый параметр запроса (например, `?username=Ilya`).
- `age: int`: Целочисленный параметр запроса (например, `?age=33`).
- **Ответ**: Возвращается JSON, содержащий переданные параметры, например, `{"user": "Ilya", "age": 33}`.
- **Валидация**: FastAPI проверяет типы параметров. Если передать `age=abc`, будет возвращена ошибка 422 (Unprocessable Content).

Посмотрим на блок-схему, чтобы еще раз разобраться как будет работать данный код.

![](https://ucarecdn.stepik.net/ca5997b8-9d84-4c33-a24c-2b1743d46090/)

Мы можем перейти по адресу [http://127.0.0.1:8000/user?username=Ilya&age=33](http://127.0.0.1:8000/user?username=Ilya&age=33) и посмотреть результат:

![](https://ucarecdn.stepik.net/796ce28c-8ac3-4149-9a60-6986853ce844/)

Также мы можем комбинировать, получая параметры пути и параметры запроса. Причем имея в части URL-адреса фиксированные пути. Несмотря на то, что параметры пути предшествуют параметрам запроса в URL-адресе, нет необходимости следовать порядку при их объявлении в определении функции.

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/employee/{name}/company/{company}")
async def get_employee(name: str, department: str, company: str) -> dict:
    return {"Employee": name, "Company": company, "Department": department}
```

Теперь мы можем перейти по адресу [http://127.0.0.1:8000/employee/Ilya/company/stepik?department=it](http://127.0.0.1:8000/employee/Ilya/company/stepik?department=it) и проверить результат в браузере или Swagger UI.

![](https://ucarecdn.stepik.net/19b99dc9-b1c3-4720-9667-9143274265eb/)

Мы видим, что независимо от объявления параметров в функции `get_employee()`, URL-адрес обрабатывается правильно, изначально идут параметры пути, и после идут параметры запроса.


## Параметры по умолчанию

Параметры по умолчанию позволяют задавать значения для параметров запросов, чтобы API мог работать, даже если клиент не передал эти параметры. Это помогает избежать ошибок и делает API более гибким. Значения по умолчанию обычно устанавливаются как:

- **`0`** для числовых типов (`int`, `float`).
- **`False`** для `bool`.
- `**""**` (пустая строка) для `str`.
- `**[]**` для `List`.
- `**{}**` для `Dict`.
- `None` для необязательных параметров.

В этой лекции мы рассмотрим, как задавать параметры по умолчанию и как они отображаются в документации FastAPI.

  
Попробуем применить значения по умолчанию к параметрам запроса, для этого возьмем код из прошлой лекции:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/user")
async def login(username: str, age: int) -> dict:
    return {"user": username, "age": age}
```

  
**В этом коде:**

- Маршрут `/user`: Обрабатывает GET-запросы с параметрами `username` (строка) и `age` (целое число).
- Валидация: FastAPI проверяет типы параметров. Если передать некорректное значение (например, `age=abc`), будет возвращена ошибка 422.

  
Запустим приложение и перейдем на страницу документации, и мы увидим что поля `username` и `age` выделены надписью *required, это значит что они являются обязательными. 

![](https://ucarecdn.stepik.net/09e84130-e4fa-4264-92c9-02e931c4b9cc/)

Зададим значение по умолчанию для параметра `age`:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/user")
async def login(username: str, age: int = 30) -> dict:
    return {"user": username, "age": age}
```

  
Мы установили значение по умолчанию для параметра `age`, и теперь в Swagger UI поле `age` больше не помечено как *required, а отображается с значением по умолчанию равным `30`.

![](https://ucarecdn.stepik.net/d8de62ee-bcd3-4cb2-b3e7-e6edef1a332b/)

А при переходе по адресу [http://127.0.0.1:8000/user?username=Ilya](http://127.0.0.1:8000/user?username=Ilya), мы уже увидим подставленное значение по умолчанию.

![](https://ucarecdn.stepik.net/70900e9f-af6c-4e6e-837a-88830b2ccff1/)

Чтобы сделать параметр полностью необязательным, можно использовать значение по умолчанию `None`:

```python
from fastapi import FastAPI

app = FastAPI()


@app.get("/user")
async def login(username: str, age: int | None = None) -> dict:
    return {"user": username, "age": age}
```

  
**Параметр** `age: int | None = None`: Делает `age` необязательным с значением по умолчанию `None`. Также мы можем это записать с типом `Optional` из модуля `typing`, например `age`: `Optional[int] = None`

  
И теперь если мы перейдем по адресу [http://127.0.0.1:8000/user?username=Ilya](http://127.0.0.1:8000/user?username=Ilya), то получим следующий результат:

![](https://ucarecdn.stepik.net/62e92158-46b9-43aa-b6c8-951af6d9e773/)

FastAPI преобразует `None` в `null` в JSON-ответе, что соответствует стандартам JSON. А в Swagger UI поле `age` отображается как необязательное без метки *required.

![](https://ucarecdn.stepik.net/eaf0d923-872b-4c93-9dca-8a9101ff886f/)

На данный момент мы проверяем получаемые значения только на соответствие типу данных. Но для правильной работы нашего API нам необходимо проверять получаемые параметры пути или запроса и писать дополнительный код для проверки входных данных.

Но FastAPI содержит уже готовые классы для валидации получаемых параметров. Они позволяют установить ограничения на допустимые значения параметров (например, минимальная и максимальная длина строки, диапазон чисел, регулярные выражения). Это предотвращает передачу некорректных данных, которые могут привести к ошибкам в работе API. Рассмотрим их в следующем разделе.